\documentclass[twoside]{article}

\input{preamble.tex}

\title{%
    Summary \\
    \large WI4425 - Financial Markets Theory
}
\author{Auke Schaap}
\date{June 2023}

\begin{document}
\maketitle
\newpage


\begin{table}[h]
    \centering
    \begin{tabular}{l|llll}
    Lecture &  Reading  &       Exercises & Document \\
    \hline
    1 &        1.1, 1.2 &       1 \& 2 & FMT 1 \\
    2 &        1.3, 2.1 &       3 \& 5 & FMT 1 \\
    3 &        2.1, 2.2 &       4, 1 & FMT 1, FMT 2 \\
    4 &        2.2, 2.3 &       2 & FMT 2 \\
    5 &        2.3 &            3.6 \& 3.8 & Book \\
    6 &        2.3, 2.4 &       1 & Insurance Dominance \\
    7 &        3.1, 3.2 &       2 & Insurance Dominance \\
    8 &        3.3, 3.4, 5.1 &  All & Portfolio \\
    9 &        5.2, 5.3 &       All & Risk neutral measure \\
    10&        4.4 &            All & Risk neutral measure
    \end{tabular}
    \caption{Overview of the lectures, readings, exercises and documents.}
\end{table}

\begin{table}[h]
    \centering
    \begin{tabular}{l|l}
    Chapter & Sections \\
    \hline
    1 & 1.1, 1.2, 1.3 \\
    2 & 2.1, 2.2, 2.3, 2.4 \\
    3 & 3.1, 3.2, 3.3, 3.4 \\
    4 & 4.4 \\
    5 & 5.1, 5.2, 5.3
    \end{tabular}
    \caption{Overview of the chapters and sections.}
\end{table}

\newpage

\lecture{1}
\section{Choices under certainty}

The couple $(X, \mathcal{R})$, represents the \textit{agent's choice problem}, where
\begin{itemize}
    \item $X$ is a set of choices, which, in the classical consumption problem, concerns bundles of goods. $X$ is therefore a subset of $\R^L$, where $L \in \N$ is the number of goods.
    \item $\mathcal{R}$ is a (weak) \textit{preference relation} on $X$. Given $x,y \in X$, if $x \mathcal{R} y$ we say that the bundle of goods $x$ is at least as preferred as the bundle of goods $y$.
\end{itemize}

From this we can derive a two other preference relations. The \textit{strong preference relation} $\mathcal{P}$ is defined as $x \mathcal{P} y \iff x \mathcal{R} y$ \text{but not} $y \mathcal{R} x$. The \textit{indifference relation} $\mathcal{I}$ is defined as $x \mathcal{I} y \iff x \mathcal{R} y $ and $y \mathcal{R} x$.

\begin{assumption}[Rationality] \label{ass:rationality}
    The preference relation $\mathcal{R}$ is said to be \textit{rational} if it satisfies:
    \begin{itemize}
        \item \textit{Reflexivity}: $x \mathcal{R} x$ for all $x \in X$.
        \item \textit{Completeness}: For all $x, y \in X$, either $x \mathcal{R} y$ or $y \mathcal{R} x$.
        \begin{explanation}
            This means that the agent is able to compare any two bundles of goods.
        \end{explanation}
        \item \textit{Transitivity}: For all $x, y, z \in X$, if $x \mathcal{R} y$ and $y \mathcal{R} z$, then $x \mathcal{R} z$.
        \begin{explanation}
            This means that the agent is able to rank all bundles of goods.
        \end{explanation}
    \end{itemize}
\end{assumption}

\begin{assumption}[Continuity] \label{ass:continuity}
    The preference relation $\mathcal{R}$ is said to be \textit{continuous} if for all $x \in X$, the sets $\{y \in X : y \mathcal{R} x\}$ and $\{y \in X : x \mathcal{R} y\}$ are closed.
\end{assumption}

Introducing a utility function $u : X \to \R$ that represents the preference relation $\mathcal{R}$ if 
\[
    x \mathcal{R} y \iff u(x) \geq u(y) \; \text{ for all } x, y \in X,
\]
we can write the agent's choice problem as the couple $(X, u)$. 

\begin{theorem}
    Let $\mathcal{R}$ be a rational and continuous preference relation on $X$. Then there exists a continuous utility function $u : X \to \R$ that represents $\mathcal{R}$.
\end{theorem}
Note that this does not say anything about the uniqueness of the utility function. If $u$ is a utility function that represents $\mathcal{R}$, then so does any strictly increasing transformation of $u$.

\begin{assumption}
    We furthermore assume that:
    \begin{itemize}
        \item $\mathcal{R}$ is strictly monotone if, for every $x, y \in X$ such that $y > x$, $x \mathcal{P} y$.
        \item $\mathcal{R}$ is strictly convex if, for every $x, y, z \in X$ with $x \not = y$ such that $x \mathcal{R} z$ and $y \mathcal{R} z$, for all $\alpha \in (0, 1)$, $\alpha x + (1 - \alpha) y \mathcal{P} z$.
    \end{itemize}
\end{assumption}
If we assume the utility functions to be twice continuously differentiable, then the first partial derivative of a utility function, the \textit{marginal utility}, is positive, and the second partial derivative is negative.

We assume that agents are characterized by \textit{substantial rationality}: An agent pursues his goals in the most appropriate way, under the constraints imposed by the environment. We, furthermore, dip the agent in a perfectly competitive market. This means that the agent is a \textit{price taker}. Given the wealth $w \in \R_{\geq0}$ and the price vector $p \in \R_{\geq 0}^L$, the set on which an agent then makes its choices (the \textit{budget constraint}) is
\[
B := \left\{x \in X : p^\top x \leq w\right\},
\]
for some closed set $X \subset \R_{\geq0}^L$. Given the couple $(X, u)$ and the budget constraint $B$, the \textit{optimal choice} is
\[
    x^* := \max_{x \in B} u(x).
\]
If the utility function is continuous, then there always exists a solution to this optimization problem, if $p \in \R_{>0}^L$.

\begin{explanation}
    As the utility function is considered to be strictly monotone, it is always optimal for an agent to spend all his wealth. Thus, the budget constraint becomes an equality constraint.
\end{explanation}

We can solve it by the Lagrangian method. The Lagrangian is:
\[
    \mathcal{L}(x, \lambda) = u(x) + \lambda (w - p^\top x).
\]
This means that we solve the set of equations:
\begin{align*}
    \frac{\partial u}{\partial x_l}\left(x^*\right) &= \lambda p_l, \; \forall l = 1, \dots, L, \\
    w &= p^\top x^*.
\end{align*}
We define the \textit{indirect utility function} as $v(\omega) \equiv u(x^*)$. 

Suppose we endow agent $i$ with endowment vector $e^i \in \R_{\geq0}^L$, and let $x(p)$ be the optimal consumption vector for price $p$. We can then write the demand $z^i(p)$ as
\[
    z^i(p) = x(p) - e^i.
\]

\begin{definition}[Internal consistency requirement]
    We require that agents optimize their utility functions under the budget constraint.
\end{definition}

\section{General Equilibrium Theory}
We have an economy with $I>1$ agents and $L>1$ goods. Every agent has solved his optimal consumption problem for his given wealth, $\omega^i = p^\top e^i$. The demand function summarizes his choices.

\begin{definition}[External consistency requirement]
    We solve the market by putting demand equal to supply:
    \[
        z(p) \equiv \sum^I_{i=1}(x^i(p) - e^i) = \mathbf{0}
    \]
\end{definition}
The price vector that solve this equation is the \textit{equilibrium price vector}. The couple $(p^*, x^*)$ is the \textit{equilibrium allocation}.

\begin{theorem}
    Let the preference relation $\mathcal{R}^i$ be rational, continuous, strictly monotone and strictly convex for all $i = 1, \dots, I$, and suppose that $\sum^I_{i=1}e^i \in \R_{>0}^L$. Then there exists a unique equilibrium price vector $p^* \in \R_{>0}^L$.
\end{theorem}

\lecture{2}

\section{Pareto optimality}
Given an economy described by $I$ couples $(\mathcal{R}^i, e^i)$, we define an allocation $x$ by:
\[
    x = (x^1, \dots, x^I) \;\; x^i \in \R_{\geq0}^L.
\]
This allocation is \textit{feasible} if we have
\[
    \sum^I_{i=1}x^i \leq \sum^I_{i=1}e^i.
\]
Given two feasible allocations $x$ and $y$, then $x$ \textit{Pareto dominates} $y$ if and only if
\begin{align*}
    x^i \mathcal{R} y^i \forall i = 1, \dots, I, \\
    \exists\; 1 \leq j \leq I : x^i \mathcal{P} y^i.
\end{align*}
\begin{explanation}
    $x$ is at least as preferred as $y$ for all agents, and strictly preferred by at least one agent. Thus, it is a better alternative.
\end{explanation}

A feasible allocation $x$ is an \textit{efficient allocation}, or \textit{Pareto optimal allocation}, if there is no other feasible allocation $y$ such that $y$ Pareto dominates $x$.

\begin{theorem}[First Welfare Theorem]
    If $(p^*, x^*)$ is a competitive equilibrium (and the preference relations of the agents are strictly monotone), then the allocation $x^*$ is Pareto optimal.
    \begin{explanation}
        So, there is an invisible hand in the market: agents maximizing their own utility in a perfectly competitive market lead to a socially optimal result.
    \end{explanation}
\end{theorem}

\begin{theorem}[Second Welfare Theorem]
    Let $x^*$ be a Pareto optimal allocation, $x^{i*} \in \R_{\geq0}^L$. If the preference relations $\mathcal{R}^i$ are rational, continuous, strictly monotone and strictly convex, then $x^*$ is the competitive equilibrium allocation, given that the initial endowments are $e^i = x^{i*}$.
    \begin{explanation}
        We can reach any Pareto optimal allocation by redistributing the goods in a proper way.
    \end{explanation}
\end{theorem}

Consider an economy $(u^i, e^i)$ and an associated competitive equilibrium $(p^*, x^*)$. Now consider an agent who has an optimal choice given the equilibrium price vector $p^*$ equal to the initial aggregate endowment. The agent has utility function
\begin{align*}
    \textbf{u}(x) := \max_{x \in \R_{\geq0}^L, i=1, \dots, I} \sum^I_{i=1}a^i u^i(x^i) \;\; \\ \text{s.t.} \sum^I_{i=1}x^i_l \leq \sum^I_{i=1}x_l.
\end{align*}
This is the \textit{social welfare function}. If the equilibrium price vector does not depend on the weights, we say that the economy satisfies the \textit{aggregation property}. If an economy satisfies the aggregation propery, then the economy with $I$ agents and the economy with the one representative agent are observationally equivalent.

\section{Choices Under Risk}

We now consider a state of the world at time $t=0$ and at $t=1$. The beliefs are modeled by a probability space $(\Omega, \mathcal{F}, \mu)$. We distinguish between:
\begin{itemize}
    \item \textit{Risk}: The probabilities are known.
    \item \textit{Uncertainty}: The probabilities are unknown.
\end{itemize}
Acts are modeled by random variables $\tilde{x}: \Omega \rightarrow \R$, where we assume $\tilde{x}$ is measurable in the following sense:
\[
    \forall B \in \mathcal{B}(\R) : \;\; \{ \omega \in \Omega : \tilde{x}(\omega) \in B \} \in \mathcal{F}.
\]
$\mu$ induces a probability measure $\pi$ on $\R$, $\pi(B) = \mu(\tilde{x}^{-1}(B))$, with $B \in \mathcal{B}(\R)$. The acts attain a finite set of values, specified a priori: $ [ x_1, \dots, x_S ], \; x_i < x_{i+1} \in \R, \;\; i = 1, \dots, S - 1$. We now have a set of acts, or \textit{gambles} $\mathcal{M}$, which are r.v.'s having support on the $x_i$ identified by a probability distribution:
\[
    \tilde{x} \in \mathcal{M} \iff \tilde{x} \equiv [x_1, \dots, x_S ; \pi_1, \dots, \pi_S] \;\; \text{s.t.} \;\; \pi_s \geq 0, \sum^S_{s=1}\pi_s = 1.
\]

\lecture{3}

\section{Expected Utility}
With the the characterization $(\mathcal{M}, \mathcal{R})$, we introduce a function of $\tilde{x}$ that represents $\mathcal{R}$, the \textit{expected utility}. We again assume rationality and continuity, but also independence:

\begin{assumption}[Independence]
    The preference relation $\mathcal{R}$ satisfies the \textit{independence} assumption, if for all $\tilde{x}_1, \tilde{x}_2, \tilde{x}_3 \in \mathcal{M}$ and $\alpha \in [0,1]$, we have
    \[
        \tilde{x}_1 \mathcal{R} \tilde{x}_2 \iff \alpha \tilde{x}_1 + (1 - \alpha)\tilde{x}_3 \mathcal{R} \alpha \tilde{x}_2 + (1 - \alpha)\tilde{x}_3.
    \]
\end{assumption}
We can now define the \textit{expected utility} by:
\[
    U(\tilde{x}) := \sum^S_{s=1}\pi_s u(x_s) = \E[u(\tilde{x})],
\]
where $u$ is the utility function that represents the preference relation with certainty.

\begin{theorem}[Theorem 2.1]
    If $\mathcal{R}$ satisfies the assumptions, then there exist $S$ scalars $u(x_s)$ such that:
    \[
        \forall \tilde{x}_1, \tilde{x}_2 \in \mathcal{M} : \;\; \tilde{x}_1 \mathcal{R} \tilde{x}_2 \iff U(\tilde{x}_1) \geq U(\tilde{x}_2).
    \]
\end{theorem}

\begin{proof}
    \todo{Learn this proof!}.
\end{proof}

\section{Risk Aversion}
A gamble $\tilde{x}$ is an \textit{actuarially fair} gamble if:
\[
    \sum^S_{s=1}\pi_s x_s = 0.
\]
We have the following types of agents:
\begin{itemize}
    \item \textit{Risk averse}: Agent does not accept or is indifferent to any actuarially fair gamble at all wealth levels.
    \item \textit{Risk neutral}: Agent is indifferent to any actuarially fair gamble.
    \item \textit{Risk loving}: Agent does accept any actuarially fair gamble.
\end{itemize}
The \textit{risk premium} of a gamble $\tilde{x}$ is the amount an agent is willing to pay to exchange his expected wealth for certain wealth, i.e. to avoid the gamble. That is, the amount $\rho_u(\tilde{x})$ such that:
\begin{align*}
    u\left(\E[\tilde{x}] - \rho_u(\tilde{x})\right) = \E[u(\tilde{x})] \\[10pt]
    \rho_u(\tilde{x}) := \max \{x \in \R_{\geq0} : u(\E[\tilde{x}] - x) = U(\tilde{x})\}
\end{align*}
The \textit{certainty equivalent} of a gamble $\tilde{x}$ is the amount of money an agent wants, to exchange his investment:
\[
    \text{CE}_u(\tilde{x}) := \E[\tilde{x}] - \rho_u(\tilde{x}).
\]

\begin{proposition}
    The following are equivalent:
    \begin{enumerate}[(i)]
        \item The agent is risk-averse.
        \item $u$ is concave.
        \item $\text{CE}_u(\tilde{x}) \leq \E[\tilde{x}]$.
        \item $\rho_u(\tilde{x}) \geq 0$.
    \end{enumerate}
    \begin{explanation}
        \todo{Explain!}.
    \end{explanation}
\end{proposition}
Let $\tilde{x} = x + \tilde{\epsilon}$, where $\tilde{\epsilon}$ is a random variable with mean zero and variance $\sigma^2$, so that $\E[\tilde{x}] = x$. Now we can write:
\[
    u\left(\E[\tilde{x}] - \rho_u(\tilde{x})\right) = u(x - \rho_u(\tilde{x})) = U(\tilde{x}).
\]
Using a Taylor expansion we find that $U(\tilde{x}) = \E[u(x + \tilde{\epsilon})] \approx u(x) + \frac{\sigma^2}{2}u''(x)$, and that $u(x - \rho_u(\tilde{x}))  \approx u(x) - u'(x)\rho_u(\tilde{x})$. Hence, $\rho_u(\tilde{x}) \approx \frac{1}{2} r^a_u(x)\sigma^2$, where
\[
    r^a_u(x) := -\frac{u''(x)}{u'(x)},
\]
the coefficient of \textit{absolute risk aversion}. If we analyse the multiplicative noise $\tilde{x} = x(1 + \tilde{\epsilon})$, we find the coefficient of \textit{relative risk aversion}:
\[
    r^r_u(x) := -\frac{u''(x)}{u'(x)}x.
\]

We use the following classification of risk-aversion:
\begin{itemize}
    \item \textit{DARA}: Decreasing absolute risk aversion, $x \mapsto r^a_u(x)$ is a decreasing function.
    \item \textit{CARA}: Constant absolute risk aversion, $x \mapsto r^a_u(x)$ is a constant function.
    \item \textit{IARA}: Increasing absolute risk aversion, $x \mapsto r^a_u(x)$ is an increasing function.
\end{itemize}
We say of two agents $a$ and $b$ that $a$ is more risk averse than $b$ if agent $b$ always accepts a gamble if agent $a$ does, or if for every gamble, the risk premium of agent $a$ is greater than or equal to the risk premium of agent $b$.

\lecture{4}

\begin{proposition} % proposition 2.2
    Given two increasing and strictly concave utility functions $u^a$ and $u^b$, the following conditions are equivalent:
    \begin{itemize}
        \item $r^a_{u^a}(x) \geq r^a_{u^b}(x)$ for all $x \in \R_{\geq0}$.
        \item There exists an increasing, concave function $g$ such that $u^a(x) = g(u^b(x))$ for all $x \in \R_{\geq0}$.
        \item $u^a$ is more risk averse than $u^b$, i.e. $\rho_{u^a}(x + \tilde{\epsilon}) \geq \rho_{u^b}(x +\tilde{\epsilon})$ for all $x \in \R_{\geq0}$ and for any random variable $\tilde{\epsilon}$ with mean zero.
    \end{itemize}
\end{proposition}
\begin{proof}
    \todo{Prove!}
\end{proof}

Examples of utility functions are:
\begin{itemize}
    \item Exponential utility functions: $u(x) = -e^{-\alpha x}$, where $\alpha > 0$.
    \begin{explanation}
        The coefficient of absolute risk aversion is $r^a_u(x) = \alpha$, which is constant (and positive). Therefore, the exponential utility function is CARA and the coefficient of relative risk aversion $r^r_u(x) = \alpha x$ is increasing.
    \end{explanation}
    \item Quadratic utility functions: $u(x) = x - \frac{b}{2}x^2$.
    \begin{explanation}
        The coefficient of absolute risk aversion is $r^a_u(x) = \frac{b}{1 - bx}$, which is increasing and positive. Therefore, the quadratic utility function is IARA and the coefficient of relative risk aversion $r^r_u(x) = \frac{bx}{1 - bx}$ is increasing.
    \end{explanation}
    \item Power utility functions: $u(x) = \frac{b}{b-1}x^{1 - \frac{1}{b}}$, where $b > 0$.
    \begin{explanation}
        The coefficient of absolute risk aversion is $r^a_u(x) = \frac{1}{bx}$, which is decreasing and positive. Therefore, the power utility function is DARA and the coefficient of relative risk aversion $r^r_u(x) = \frac{1}{b}$ is constant.
    \end{explanation}
    \item Logarithmic utility functions: $u(x) = \ln(bx)$, where $b > 0$.
    \begin{explanation}
        The coefficient of absolute risk aversion is $r^a_u(x) = \frac{1}{x}$, which is decreasing and positive. Therefore, the logarithmic utility function is DARA and the coefficient of relative risk aversion $r^r_u(x) = 1$ is constant.
    \end{explanation}
\end{itemize}

\section{Portfolio Problem}

An agent with initial wealth $W_0$ faces the following problem. Allocate $W_0$ among $N+1$ assets, of which $N$ are risky. The return of asset $n$ at time 1 is described by $\tilde{r}_n$, with $n = 1, \dots, N$. Asset 0 is the risk-free asset with return $r_f$. There are $S$ possible outcomes:
\[
    \begin{pmatrix}
        r_{11} & r_{12} & \dots & r_{1N} \\
        r_{21} & r_{22} & \dots & r_{2N} \\
        \vdots & \vdots & \ddots & \vdots \\
        r_{S1} & r_{S2} & \dots & r_{SN}
    \end{pmatrix}
\]
The agent invests the vector with amounts $\mathbf{w} = (w_1, \dots, w_N)$, $\mathbf{w} \in \R^{N}$. The budget constraint forces the agent to invest the rest in the risk-free asset:
\[
    W_0 - \sum_{n=0}^N w_n.
\]
The wealth at time 1 becomes $y = R\mathbf{w}^\top$. The \textit{consumption plans} $\mathbf{c}$ reachable in $\R^S$ are given by the image of the transformation $R$, written as $I(R)$. A market is complete if every consumption plan is reachable, i.e. $I(R) = \R^S$. The $N$ assets are said to be \textit{non redundant} if their returns are linearly independent, i.e. $N \leq S$ and $\text{rank}(R) = N$. The \textit{uniqueness of representation} property states that for all $\mathbf{c} \in I(R)$ there exists a unique $\mathbf{w} \in \R^N$ such that $\mathbf{c} = R\mathbf{w}^\top$. 

\lecture{5}

Assuming $R$ is full rank, the following cases are possible:
\begin{itemize}
    \item $N > S$: $I(R) = \R^S$, and $\dim\{\mathbf{w} : R\mathbf{w}^\top = \mathbf{c}\} = N-S$.
    \begin{explanation}
        The market is complete, as every possible consumption plan is reachable ($I(R) = \R^S$). Some assets are \textit{redundant}. The number of redundant assets is $N-S$, and the number of non-redundant assets is $S$.
    \end{explanation}
    \item $N = S$: $I(R) = \R^S$, and $\dim\{\mathbf{w} : R\mathbf{w}^\top = \mathbf{c}\} = 0$.
    \begin{explanation}
        The market is complete, as every possible consumption plan is reachable ($I(R) = \R^S$). There are no redundant assets, as the number of non-redundant assets is $S$.
    \end{explanation}
    \item $N < S$: $I(R) \subset \R^S$, and $\dim\{\mathbf{w} : R\mathbf{w}^\top = \mathbf{c}\} = 0$.
    \begin{explanation}
        The market is incomplete, as not every possible consumption plan is reachable ($I(R) \subset \R^S$). There are no redundant assets, as the number of non-redundant assets is $S$.
    \end{explanation}
\end{itemize}
The wealth at $t_1$ associated with the portfolio is given by:
\begin{align*}
    \tilde{W} &= \left(W_0 - \sum_{n=1}^N w_n\right)r_f + \sum_{n=1}^N w_n \tilde{r}_n \\
    &= W_0r_f + \sum_{n=1}^N w_n(\tilde{r}_n - r_f).
\end{align*} 
An agent would maximize his expected utility given an initial wealth. Hence, the agent's \textit{optimal portfolio problem} is given by:
\[
    \max_{\mathbf{w}} \E[u(\tilde{W})], \;\;\; \mathbf{w} \in \R^N.
\]
The first order necessary condition is given by $\E[u'(\tilde{W})(\tilde{r}_n - r_f)] = 0$, with $n = 1, \dots, N$. If $u'' < 0$, then there is a \textit{unique wealth value} $W$ that yield the maximum of the utility functions. This will be attained by a unique portfolio if the assets statisfy the uniqueness of representation property. The \textit{return risk premium} is defined as:
\[
    \E[\tilde{r}_n - r_f].
\]

\begin{proposition}
    Consider a strictly risk averse agent with a strictly increasing utility function. A sufficient condition such that $\mathbf{w}^* \not\in \R^N_{\geq 0}$ is that the return risk premium of all assets is non positive, and negative for at least one asset.
    \begin{explanation}
        As the agent is risk averse, he requires a positive risk premium to invest in a risky asset. If the risk premium is zero, the agent will not invest in the asset. If the risk premium is negative, the agent will short the asset. Hence, $\mathbf{w}^* \in \R^N_{\leq 0}$.
    \end{explanation}
\end{proposition}

\begin{proposition}
 A necessary and sufficient conditions so that $\mathbf{w}^* = 0$ for an agent with a strictly increasing and strictly concave utility function is that
\[
    \E[\tilde{r}_n]  = r_f, \;\;\; n = 1, \dots, N.
\]
\begin{explanation}
    The agent is risk averse, due to the concavity of the utility function. Hence, the agent will only invest in a risky asset for a positive risk premium. If the risk premium is zero, the agent will invest in the risk-free asset, so $\mathbf{w}^* = 0$.
\end{explanation}
\end{proposition}

\begin{proposition}
    Given $N$ risky assets with returns $\tilde{r}_1, \dots, \tilde{r}_N$, and a risk-free asset with return $r_f > 0$. Let $u$ be differentiable, strictly increasing and concave. Then for $n = 1, \dots, N$:
    \begin{align*}
        \E[\tilde{r}_n - r_f] &\geq 0 \iff \mathbf{w}^* = cov\left(\tilde{r}_n, u'(W_0\tilde{r}^*)\right) \leq 0, \\
        \E[\tilde{r}_n - r_f] &\leq 0 \iff \mathbf{w}^* = cov\left(\tilde{r}_n, u'(W_0\tilde{r}^*)\right) \geq 0.
    \end{align*}
    \begin{explanation}
        A risk-averse agent wants to reduce the variance of his portfolio. For assets that do this (i.e. negative correlation between asset returns and wealth), a negative risk premium is accepted. For assets that increase the variance of the portfolio, a positive risk premium is required.
    \end{explanation}
\end{proposition}

For returns with a small dispersion, the following approximation holds:
\[
    \E[\tilde{r}_n - r_f] \approx - \frac{u''\left(\E[\tilde{W}^*]\right)}{u'\left(\E[\tilde{W}^*]\right)} cov\left(\tilde{r}_n, \tilde{W}^*\right)
\]

\lecture{6}

\begin{proposition}
    If the returns $\tilde{r}_n$, with $n = 1, \dots, N$, are iid, then the optimal portfolio for a risk averse agent is given by:
    \[
        w_n = \frac{W_0}{N}.
    \]
\end{proposition}

\begin{proposition}
    If an agent is risk averse with a strictly increasing utility function, then
    \[
        \E[\tilde{r}_n] - r_f \geq 0.
    \]
\end{proposition}

Limit our portfolio problem to one risky and one risk-free asset. By $w(x)$ we denote the risky asset demand of an agent with initial wealth $x$.

\begin{proposition}
    Let $u$ be an increasing, three times differentiable and strictly concave utility function. Then:
    \begin{align*}
        r^{a'}_u(z) < 0 \;\;\; \forall z \in \R_{\geq 0} & \implies w'(x) > 0 \;\;\; \forall x \in \R_{\geq 0} \\
        r^{a'}_u(z) > 0 \;\;\; \forall z \in \R_{\geq 0} & \implies w'(x) < 0 \;\;\; \forall x \in \R_{\geq 0} \\
        r^{a'}_u(z) = 0 \;\;\; \forall z \in \R_{\geq 0} & \implies w'(x) = 0 \;\;\; \forall x \in \R_{\geq 0}
    \end{align*}
    \begin{explanation}
        DARA agents will increasingly invest in risky assets. IARA agents will decreasingly invest in risky assets. CARA agents will invest a constant proportion of their wealth in risky assets.
    \end{explanation}
\end{proposition}

The absolute risk aversion coefficient gives information of changes in the levels of the risky asset demand, not in the percentage of wealth invested in the risky asset. For that, we use the relative risk aversion coefficient.

\begin{proposition}
    Let $u$ be an increasing, three times differentiable and strictly concave utility function. Then:
    \begin{align*}
        r^{r'}_u(z) < 0 \;\;\; \forall z \in \R_{\geq 0} & \implies \frac{dw}{dx}\frac{x}{w} < 1 \;\;\; \forall x \in \R_{\geq 0} \\
        r^{r'}_u(z) > 0 \;\;\; \forall z \in \R_{\geq 0} & \implies \frac{dw}{dx}\frac{x}{w} > 1 \;\;\; \forall x \in \R_{\geq 0} \\
        r^{r'}_u(z) = 0 \;\;\; \forall z \in \R_{\geq 0} & \implies \frac{dw}{dx}\frac{x}{w} = 1 \;\;\; \forall x \in \R_{\geq 0}
    \end{align*}
    \begin{explanation}
        \todo{Explain}
    \end{explanation}
\end{proposition}

\section{Insurance, Demand and Prudence}
An \textit{Arrow} security delivers at time $t=1$ exactly one unit of wealth if an elementary event is realized, and zero otherwise. Suppose a strictly risk averse agent endowed in $t=0$ with an amount of money $W_0>0$ faces a possible monetary loss $D>0$ at time $t=1$, where the loss occurs with probability $0 < \pi < 1$. The expected utility is given by:
\[
    \pi u(W_0 - D) + (1-\pi)u(W_0).
\]
Suppose the agent can buy an Arrow security that pays one unit of wealth in case the loss occurs. The price of this unit of wealth is $q>0$. The agent must solve the following optimization problem:
\[
    \max_{q} \pi u(W_0 - D - wq + w) + (1-\pi)u(W_0 - wq), \;\;\; w \in \R_{\geq 0}.
\]
Here $w^* \geq 0$ is a solution of the problem if and only if:
\[
    \pi(1-q) u'(W_0 - D - w^*q + w^*) - q(1-\pi)u'(W_0 - w^*q) \leq 0,
\]
with equality for $w^* > 0$. The Arrow security is in fact a gamble: $[1-q, -q; \pi, 1-\pi]$. The gamble is actuarially fair for $q = \pi$. So, for $w^* > 0$ we have
\[
    u'\left(W_0 - D + w^*(1-q)\right) = u'\left(W_0 - w^*q\right).
\]
By concavity of $u$ we find $w^* = D$, so for actuarially fair price, the risk averse agent will insure themself completely. If the gamble is not fair, then there is partial insurance in case $q > \pi$, and over insurance in case $q < \pi$.

Consider now the generic gamble $\tilde{x} = [x_1, x_2; \pi, 1-\pi]$. The ratio of the marginal utilities in two states of the world, weighted by the probability of that state, denoted $\text{SMS}(x_1, x_2)$, is called the \textit{marginal rate of substitution}. This is equal to minus the slope of the tangent line to the indifference curve at the point $(x_1, x_2)$:
\[
    \text{SMS}(x_1, x_2) = \left.-\frac{dx_2}{dx_1}\right|_{U(x) = \tilde{U}} = - \frac{\pi u'(x_1)}{(1-\pi)u'(x_2)}.
\]
\begin{figure}[ht]
    \centering
    \incfig[0.65]{insurance}
    \caption{Expected utility in the state space. }
    \label{fig:insurance}
\end{figure}
This allows us to show that the indifference curves in the state space are convex. It suffices to show that
\[
    \frac{d\text{SMS}(x_1, x_2)}{dx_1} \leq 0, \;\;\; \forall x_1, x_2 \in \R^2_{\geq 0}.
\]

Now suppose you can buy Arrow securities paying 1 in case you end up in $x_1$, or $x_2$, with prices $q_1$ and $q_2$. Then the optimization problem becomes
\begin{align*}
    \max_{x_1, x_2} U(x_1, x_2) = \pi u(x_1) + (1-\pi)u(x_2) \\
    \text{s.t. } \; q_1x_1 + q_2x_2 \leq q_1e1 + q_2e2.
\end{align*}
Then we find as necessary condition to be satisfied in the solution:
\[
    \frac{\pi u'(x^*_1)}{(1-\pi)u'(x^*_2)} = \frac{q_1}{q_2}.
\]
In case the securities are fairly priced, the agent will reach an endowment with no risk. Otherwise,
\begin{align*}
    \frac{q_1}{q_2} > \frac{\pi}{(1-\pi)} & \implies x^*_1 < x^*_2 \\
    \frac{q_1}{q_2} < \frac{\pi}{(1-\pi)} & \implies x^*_1 > x^*_2.
\end{align*}

\lecture{7}

\section{Stochastic Dominance}
Take the portfolio problem setup with $N$ risky assets, having random returns $\tilde{r}_i$, with covariance matrix
\[
    V = \begin{pmatrix}
        \sigma^2_1  & cov(\tilde{r}_1, \tilde{r}_2) & \cdots & cov(\tilde{r}_1, \tilde{r}_N) \\
        cov(\tilde{r}_2, \tilde{r}_1) & \sigma^2_2 & \cdots & cov(\tilde{r}_2, \tilde{r}_N) \\
        \vdots & \vdots & \ddots & \vdots \\
        cov(\tilde{r}_N, \tilde{r}_1) & cov(\tilde{r}_N, \tilde{r}_2) & \cdots & \sigma^2_N
    \end{pmatrix}.
\]
Furthermore, we denote the relative weights by
\[
    w \in \Delta_N, \;\;\; \Delta_N = \left\{x \in \R^N  : \; \sum_{i=1}^N x_i = 1\right\}.
\]
Then, by denoting by $e$ the vector of expected returns of the random assets, we find for expected return and variance of the portfolio:
\begin{align*}
    \E[\tilde{r}] = w^\top e = \sum^N_{i=1}w_ie_i = \sum^N_{i=1}w_i\E[\tilde{r}_i], \\
    \sigma^2(w) = w^\top V w = \sum^N_{i=1}\sum^N_{j=1}w_icov(\tilde{r}_i, \tilde{r}_j)w_j.
\end{align*}
The matrix $V$ is symmetric. In case all returns are linearly independent, then the matrix $V$ is non singular and positive definite.

\begin{definition}[First order stochastic dominance]
    A portfolio $w^1$ stochastically dominates $w^2$ according to the \textit{first order stochastic dominance} criterion ($w^1 \succeq_{FSD} w^2$) if and only if $U(\tilde{r}_1) \geq U(\tilde{r}_2)$ for all non-decreasing utility functions.
\end{definition}

For this proposition, we assume the random variables to be normalized to the interval $[0, 1]$, so $F_i(1) = 1$.
\begin{proposition}
    The following statements are equivalent:
    \begin{itemize}
        \item $w^1 \succeq_{FSD} w^2$
        \item $F_1(x) \leq F_2(x)$ for all $x \in [0, 1]$
        \item $\tilde{r}^1 =^d \tilde{r}^2 + \tilde{\epsilon}$ where $\tilde{\epsilon}$ is a positive random variable.
    \end{itemize}
\end{proposition}
This is relatively weak, as it is defined on a large class of utility functions.
\begin{definition}[Second order stochastic dominance]
    A portfolio $w^1$ stochastically dominates $w^2$ according to the \textit{second order stochastic dominance} criterion ($w^1 \succeq_{SSD} w^2$) if and only if $U(\tilde{r}_1) \geq U(\tilde{r}_2)$ for all concave utility functions.
\end{definition}

\begin{proposition}
    The following statements are equivalent:
    \begin{itemize}
        \item $w^1 \succeq_{SSD} w^2$
        \item $\E[\tilde{r}^1] \geq \E[\tilde{r}^2]$, with $G(y) = \int_0^y\left(F_1(z) - F_2(z)\right) dz \leq 0$ for all $y \in [0, 1]$.
        \item $\tilde{r}^2 =^d \tilde{r}^1 + \tilde{\epsilon}$, where $\tilde{\epsilon}$ is a random variable such that $\E[\tilde{\epsilon} | \tilde{r}^1] = 0$.
    \end{itemize}
\end{proposition}
The result of this is that
\[
    w^1 \succeq_{SSD} w^2 \implies \E[\tilde{r}^1] = \E[\tilde{r}^2] \text{ and } \sigma^2(w^1) \leq \sigma^2(w^2).
\]
We now have partial ordering, i.e. only for portfolios with the same expected return.
\begin{definition}[Second order stochastic monotonic dominance]
    A portfolio $w^1$ stochastically dominates $w^2$ according to the \textit{second order stochastic monotonic dominance} criterion ($w^1 \succeq_{SSD}^M w^2$) if and only if $U(\tilde{r}_1) \geq U(\tilde{r}_2)$ for all non-decreasing and concave utility functions.
\end{definition}

\begin{proposition}
    The following statements are equivalent:
    \begin{itemize}
        \item $w^1 \succeq_{SSD}^M w^2$
        \item $\E[\tilde{r}^1] \geq \E[\tilde{r}^2]$, with $G(y) = \int_0^y\left(F_1(z) - F_2(z)\right) dz \leq 0$ for all $y \in [0, 1]$.
        \item $\tilde{r}^2 =^d \tilde{r}^1 + \tilde{\epsilon}$, where $\tilde{\epsilon}$ is a random variable such that $\E[\tilde{\epsilon} | \tilde{r}^1] \leq 0$.
        \item $\tilde{r}^2 =^d \tilde{r}^1 + \tilde{\xi} + \tilde{\nu}$, where $\tilde{\xi}$ is a positive random variable and $\E[\tilde{\nu} | \tilde{r}^1 + \tilde{\xi}] = 0$.
    \end{itemize}
\end{proposition}

Note that, by definition, second order stochastic dominance implies second order stochastic monotonic dominance. That is, if $w^1 \succeq_{SSD} w^2$, then $w^1 \succeq_{SSD}^M w^2$.

\section{Mean-Variance Analysis}

The \textit{mean-variance} criterion is given by:
\[
    w^1 \succeq_{MV} w^2 \iff \E[\tilde{r}^1] \geq \E[\tilde{r}^2] \text{ and } \sigma^2(w^1) \leq \sigma^2(w^2).
\]
\begin{explanation}
    That is, an agent prefers random variables with higher expected values, and dislikes random variables with higher variance.
\end{explanation}
This is again a partial ordering; there is no ordering for portfolios with higher risk and higher expected return, or lower risk and lower expected return. The justification for the criterion is as follows. If $u$ is quadratic, then $w^1 \succeq_{MV} w^2 \iff U(w^1) \geq U(w^2)$. We can expand this up to the second order, and find that $\E[u(\tilde{r})] \approx u(\E[\tilde{r}]) + \frac{1}{2}u''(\E[\tilde{r}])\sigma^2(\tilde{r})$.

\lecture{8}

\section{Portfolio Frontier}

The \textit{porfolio frontier} (PF) is identified by the second order stochastic dominance criterion. Given a portfolio with expected return $\E[\tilde{r}^p]$. The portfolio $w^p$ that is not SSD by any other portfolios with that return, i.e. the portfolio with the smallest variance of all portfolios having that return, is part of the PF. We can find $w^p$ by solving:
\begin{align*}
    \min_w& \;\frac{1}{2}w^\top V w, \;\;\; w \in \R^N \\
    \text{s.t.}&  \;\;\; w^\top e = \E[\tilde{r}^p], \;\;\; \sum_{i=1}^N w_i = 1.
\end{align*}

The solution to this is given by
\[
    w^p = g + h \E[\tilde{r}^p],
\]
where $g$ and $h$ are not dependent on the expected return, and given by:
\begin{align*}
    g = \frac{BV^{-1}\mathbf{1}-AV^{-1}e}{D}, && h = \frac{CV^{-1}e - AV^{-1}\mathbf{1}}{D},
\end{align*}
\vspace{-15pt}
\begin{align*}
    A = \mathbf{1}^\top V^{-1}e, && B = e^\top V^{-1}e, && C = \mathbf{1}^\top V^{-1} \mathbf{1}, && D = BC - A^2.
\end{align*}

The PF has the following important properties:
\begin{enumerate}
    \item Given two portfolios in the PF, then any other portfolio can be attained by a linear combination of those 2 portfolios.
    \item The covariance and variance are given by:
    \begin{align*}
        cov(\tilde{r}^p, \tilde{r}^q) = \frac{C}{D}\left(\E[\tilde{r}^p] - \frac{A}{C}\right)\left(\E[\tilde{r}^q] - \frac{A}{C}\right) + \frac{1}{C} \\
        \sigma^2(w^p) = \frac{1}{D}\left(C\E[\tilde{r}^p]^2 - 2A\E[\tilde{r}^p] + B\right).
    \end{align*}
    \item The PF is a hyperbola in the mean-standard-deviation (MSD) diagram, and a parabola in the mean-variance (MVAR) diagram. The portfolio with the minimal standard deviation $w^MVP$ defines the \textit{minimum variance point} in the diagrams,
    \[
        w^{MVP} = \frac{V^{-1} \mathbb{I}}{C}.
    \]
    \item For every expected return, there is one point on the PF. For every standard deviation or variance (beyond the minimal variance point) there are two points on the PF. We define the \textit{efficient portfolio frontier} (EPF) as the part of the PF that is above the minimal variance point, i.e.
    \[
        \text{EPF} = \left\{w \in PF : \E[\tilde{r}] > \frac{A}{C}\right\}.
    \]
    The lower branch is the inefficient part of the PF. In case agents maximize their expected utility, then restriction to the EPF is justified if the utility function is increasing in average return and decreasing in variance.

    \item Given a portfolio $w^p$ belonging to the PF, there exists a portfolio $w^{zc(p)}$ (also belonging to the PF) that has zero covariance with $w^p$. For the return of this portfolio we find
    \[
        \E[\tilde{r}^{zc(p)}] = \frac{A}{C} - \frac{\frac{D}{C^2}}{\E[\tilde{r}^p] - \frac{A}{C}}
    \]
\end{enumerate}

\begin{proposition} \label{prop:3.4}
    Let $w^q$ be a portfolio and let $w^p$ be a portfolio that belongs to the PF, and that is not the minimal variance portfolio. Then
    \begin{align*}
        w^q \in PF &\implies \tilde{r}^q = (1-\beta_{qp})\tilde{r}^{zc(p)} + \beta_{qp}\tilde{r}^p, \\
        w^q \not\in PF &\implies \tilde{r}^q = (1-\beta_{qp})\tilde{r}^{zc(p)} + \beta_{qp}\tilde{r}^p + \tilde{\epsilon}^{qp},
    \end{align*}
    where
    \[
        \E[\tilde{\epsilon}^{qp}] = 0, \;\;\;\;\; \beta_{qp} = \frac{cov(w^p, w^q)}{\sigma^2(w^p)}.
    \]
\end{proposition}

Note that the return of any portfolio is the linear combination of a portfolio on the frontier, its zero-covariance counterpart and a random variable with zero mean and zero covariance with the frontier portfolios. Furthermore, the coefficients of the frontier portfolio and its zero covariance counterpart are the regression coefficients of the portfolio on those frontier portfolios.

\todo{Excel example?}

\section{Portfolio Frontier with a Risk-Free Asset}

Consider now the setup of $N$ risky assets, with a risk-free asset included. The constraint $W \in \Delta_N$, with $\Delta_N = \{x \in \R^N : \sum_{n=1}^{N} = 1\}$. We can relax this by investing the fraction $1 - w^\top \mathbb{I} = 1 - \sum_{n=1}^{N} w_n$ in the risk-free asset. In order to identify the portfolio frontier that includes the risk-free asset (PF\textsuperscript{*}), we have to solve the same problem, but under a single constraint:
\begin{align*}
    \min_w \frac{1}{2}w^\top V w, \;\;\; w \in \R^N, \\
    \text{s.t.} \;\;\; w^\top e + (1-w^\top \mathbb{I})r_f = \E[\tilde{r}^p].
\end{align*}

As the PF is a hyperbola in the MSD diagram, we have that, if $r_f \not= \frac{A}{C}$, then there is exactly one point in which the PF and PF\textsuperscript{*} coincide. If $r_f < \frac{A}{C}$, this is a point on the EPF. If $r_f > \frac{A}{C}$, then this is a point on the lower branch of the PF, so it is inefficient. 

\begin{figure}[ht]
    \centering
    \incfig{epf}
    \caption{The efficient portfolio frontier.}
    \label{fig:epf}
\end{figure}

\begin{proposition}
    Let $w^q$ be a portfolio and let $w^p$ be a portfolio that belongs to the PF\textsuperscript{*}, where the expected return of $w^p$ is not equal to the risk-free rate. Then
    \begin{align*}
        w^q \in PF^* &\implies \tilde{r}^q = (1-\beta_{qp})r_f + \beta_{qp}\tilde{r}^p, \\
        w^q \not\in PF^* &\implies \tilde{r}^q = (1-\beta_{qp})r_f + \beta_{qp}\tilde{r}^p + \tilde{\epsilon}^{qp},
    \end{align*}
    where
    \[
        cov(\tilde{r}^q, \tilde{\epsilon}^{qp}) = \E[\tilde{\epsilon}^{qp}] = 0, \;\;\;\;\; \beta_{qp} = \frac{cov(\tilde{r}^q, \tilde{r}^p)}{\sigma^2(\tilde{r}^p)}.
    \]
    Moreover, for any portfolio $w^q$,
    \[
        \E[\tilde{r}^q] - r_f = \beta_{qp}(\E[\tilde{r}^p] - r_f).
    \]
\end{proposition}

That brings us to the \textit{mutual fund separation} property: For any portfolio $w^q$, there is a portfolio that is on the EPF\textsuperscript{*} which is a linear combination of the risk-free and tangent portfolio on the EPF, that is better in the SSD sense. \todo{rewrite this sentence}

\section{CAPM}

Consider an economy with $I$ agents ($i = 1, \dots, I$). The wealth of agent i at time $t=0$ is given by $W^i_0 \geq 0$. The percentage of wealth that agent $i$ holds in asset $n$ is given by $w^i_n$, with $n = 1, \dots, N$. The return of asset $n$ is given by the random variable $\tilde{r}^n$, with finite variance. The wealth of the economy is then given by
\[
    W_0^m = \sum_{i=1}^{I} W_0^i.
\]
The percentage of wealth that the economy holds in asset $n$ is given by
$w^m_n$ and $w^m$ is called the market portfolio. We have the following assumptions:
\begin{itemize}
    \item Perfectly competitive markets.
    \item No transaction costs and taxes, and assets are perfectly divisible.
    \item Agent's preferences can be represented through the expected utility.
    \item Agents are risk averse.
    \item The probabilistic framework is common knowledge.
    \item The mutual fund separation property holds, or agent's optimal portfolios belong to the PF.
    \item The economy is closed.
\end{itemize}

In equilibrium, the market demand of an asset must be equal to its supply. That is,
\[
    w^m_n = \sum_{i=1}^{I} w^i_n \frac{W^i_0}{W^m_0}
\]
If agents' portfolios belong to the PF, then the market portfolio $w^m$ also belongs to the PF. If $w^m$ is different from the minimal variance point, we can use \cref{prop:3.4} to obtain
\begin{align*}
    \E[\tilde{r}^q] = \E[\tilde{r}^{zc(m)}] + \beta_{qm}\left(\E[\tilde{r}^m] - \E[\tilde{r}^{zc(m)}]\right), \\
    \tilde{r}^m = \sum_{n=1}^{N} w^m_n \tilde{r}^n, \;\;\; \beta_{qm} = \frac{cov(w^q, w^m)}{\sigma^2(w^m)}.
\end{align*}
This is a straight line in the beta-expected return plane. The line is called the \textit{security market line}. If the slope of the line is positive, then the market portfolio is efficient. If the slope is negative, then the market portfolio is inefficient. \todo{multivariate normal asset returns}

Including the risk free asset gives the relationship
\[
    \E[\tilde{r}^q] = r_f + \beta_{qm}\left(\E[\tilde{r}^m] - r_f\right).
\]
If $r_f < \frac{A}{C}$ then the market portfolio is efficient, and all agents hold a combination of the risk-free asset and the market portfolio. If $r_f > \frac{A}{C}$, then the market portfolio is inefficient, and all agents hold only the risk-free asset.

Conclusions:
\begin{itemize}
    \item The CAPM is a one-factor model, where beta is the factor that linearly relates the risk premium of a portfolio.
    \item The risk premium of a portfolio has the same sign as the risk premium of the market portfolio in case of positive correlation. In case of negative correlation, it has the opposite sign.
    \item The return of a portfolio can be decomposed into a constant, a risk component associated with market return (systemic risk), and a component with zero mean and zero correlation with market return (idiosyncratic risk).
\end{itemize}


\section{Empirical Test CAPM}

\lecture{9}

\section{Arbitrage Pricing Theory}

\lecture{10}

\section{Fundamental Theorem of Asset Pricing}


\end{document}